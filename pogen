#!/usr/bin/env bash
# shellcheck source=common.sh
###############################################################################
# SPDX-FileComment: Update POT file and merge with existing PO file
#
# SPDX-FileCopyrightText: Karel Zimmer <info@karelzimmer.nl>
# SPDX-License-Identifier: CC0-1.0
###############################################################################

###############################################################################
# Imports
###############################################################################

source common.sh


###############################################################################
# Constants
###############################################################################

readonly SCRIPTS_REPO=$HOME/kz-scripts
readonly ITS_DIR=$HOME/kz-scripts/usr/share/gettext/its
readonly LC_MESSAGES_DIR=$HOME/kz-scripts/usr/share/locale/nl/LC_MESSAGES
readonly GETTEXT_DIRS="\
$HOME/kz-scripts/usr/bin \
$HOME/kz-scripts/usr/share/applications \
$HOME/kz-scripts/usr/share/polkit-1/actions
"

###############################################################################
# Globals
###############################################################################


###############################################################################
# Main
###############################################################################

init_script

declare text=''
declare gettext_dir=''
declare gettext_file=''
declare text=''
declare language=''
declare language_specification=''

text=$(gettext 'Generate gettext files')...
printf '%s\n' "$text"

# Generate the following gettext files:
# 1. The readable Portable Object Template (POT) file from the source code in
#    repo kz-scripts,
# 2. the readable Portable Object (PO) file from the POT file, and
# 3. the binary Machine Object (MO) file from the PO file.
for gettext_dir in $GETTEXT_DIRS; do

    cd "$gettext_dir" || exit 1

    for gettext_file in *; do
        if [[ -d $gettext_file ]]; then
            text="$gettext_dir/$gettext_file: is een map"
            printf '%s\n' "$text"
            continue
        elif ! [[ -f $gettext_file ]]; then
            text="$gettext_dir/$gettext_file: is geen bestand"
            printf '%s\n' "$text"
            continue
        elif [[ $gettext_file =~ .*.gpg$ ]]; then
            text="$gettext_dir/$gettext_file: is met GPG versleuteld"
            printf '%s\n' "$text"
            continue
        elif [[ $gettext_file =~ .*.pot$ ]]; then
            text="$gettext_dir/$gettext_file: is een gettext POT-bestand"
            printf '%s\n' "$text"
            continue
        fi

        if grep --quiet '^# shellcheck ' "$gettext_file"; then
            language='Shell'
            language_specification="--language=$language"
        elif grep --quiet '^import ' "$gettext_file"; then
            language='Python'
            language_specification="--language=$language"
        elif grep --quiet 'Desktop Entry' "$gettext_file"; then
            language='Desktop'
            language_specification="--language=$language"
        elif grep --quiet 'policyconfig' "$gettext_file"; then
            language='Policy'
            language_specification="--its=$ITS_DIR/kz-policy.its"
        else
            text="$gettext_dir/$gettext_file: kan de taal niet bepalen"
            printf '%s\n' "$text"
            continue
        fi

        printf '%s' "$gettext_dir/$gettext_file: "

        xgettext    "$language_specification"                   \
                    --join-existing                             \
                    --package-name='kz'                         \
                    --package-version='4.2.1'                   \
                    --copyright-holder='Karel Zimmer'           \
                    --msgid-bugs-address='info@karelzimmer.nl'  \
                    --output="$SCRIPTS_REPO/usr/bin/kz.pot"     \
                    "$gettext_file"

        msgmerge    --update                        \
                    --backup=none                   \
                    --previous                      \
                    "$LC_MESSAGES_DIR/kz.po"        \
                    "$SCRIPTS_REPO/usr/bin/kz.pot"
    done
done

printf '%s\n' "$(gettext 'Complete!')"
exit 0
